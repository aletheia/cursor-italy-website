---
import {
  Calendar,
  Clock,
  MapPin,
  ExternalLink,
  ArrowLeft,
} from 'lucide-react';
import { getCollection, render } from 'astro:content';

import BaseLayout from '@/layouts/BaseLayout.astro';
import { siteConfig } from '@/lib/config';

export async function getStaticPaths() {
  const events = await getCollection('events');
  const paths = [];

  for (const event of events) {
    // Main event page: /events/[slug]
    paths.push({
      params: { slug: event.slug },
      props: { event, isLive: false },
    });

    // Live stream page: /events/[slug]/live
    paths.push({
      params: { slug: `${event.slug}/live` },
      props: { event, isLive: true },
    });
  }

  return paths;
}

const { event, isLive } = Astro.props;
const { data, slug } = event;

const eventDate = new Date(data.date);
// Compare dates only (not time) for determining if event is upcoming
const today = new Date();
today.setHours(0, 0, 0, 0);
const eventDateOnly = new Date(data.date);
eventDateOnly.setHours(0, 0, 0, 0);
const isUpcoming = eventDateOnly >= today;

// Render markdown content
const { Content } = await render(event);
---

<BaseLayout
  title={isLive ? `${data.title} - Live Stream` : data.title}
  description={data.description}
  image={data.image}
  type='event'
>
  {isLive ? (
    <!-- Live Stream Page -->
    <div class='min-h-screen bg-gray-50'>
      <!-- Header -->
      <section class='bg-white border-b'>
        <div class='max-w-7xl mx-auto container-padding py-6'>
          <a
            href={`/events/${slug}`}
            class='inline-flex items-center text-cursor-blue hover:text-blue-700 transition-colors duration-200 mb-4'
          >
            <ArrowLeft className='w-4 h-4 mr-2' />
            Back to Event Details
          </a>

          <h1 class='text-3xl lg:text-4xl font-bold text-gray-900'>
            {data.title} - Live Stream
          </h1>
        </div>
      </section>

      <!-- Live Stream -->
      <section class='section-padding'>
        <div class='max-w-7xl mx-auto container-padding'>
          <div class='bg-white rounded-2xl shadow-lg overflow-hidden'>
            <!-- YouTube Embed -->
            {data.youtubeId ? (
              <div class='relative w-full' style='padding-bottom: 56.25%'>
                <iframe
                  class='absolute top-0 left-0 w-full h-full'
                  src={`https://www.youtube.com/embed/${data.youtubeId}?autoplay=1&rel=0`}
                  title={data.title}
                  allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share'
                  allowfullscreen
                />
              </div>
            ) : (
              <div class='relative w-full bg-gray-900 flex items-center justify-center' style='padding-bottom: 56.25%'>
                <div class='absolute inset-0 flex items-center justify-center'>
                  <p class='text-white text-xl'>Live stream coming soon...</p>
                </div>
              </div>
            )}

            <!-- Event Info Below Stream -->
            <div class='p-8'>
              <h2 class='text-2xl font-bold text-gray-900 mb-4'>
                About This Event
              </h2>
              <p class='text-lg text-gray-600 mb-6'>{data.description}</p>

              <div class='flex flex-wrap gap-4'>
                <a href={`/events/${slug}`} class='btn btn-primary'>
                  View Event Details
                </a>
                {data.registrationUrl && (
                  <a
                    href={data.registrationUrl}
                    target='_blank'
                    rel='noopener noreferrer'
                    class='btn btn-secondary'
                  >
                    Register for Future Events
                  </a>
                )}
              </div>
            </div>
          </div>

          <!-- Speakers -->
          {data.speakers && data.speakers.length > 0 && (
            <div class='mt-12'>
              <h2 class='text-2xl font-bold text-gray-900 mb-6'>
                Today's Speakers
              </h2>
              <div class='grid grid-cols-1 md:grid-cols-2 gap-6'>
                {data.speakers.map((speaker) => (
                  <div class='bg-white rounded-xl p-6 shadow-md'>
                    <h3 class='text-xl font-bold text-gray-900 mb-2'>
                      {speaker.name}
                    </h3>
                    <h4 class='text-lg font-semibold text-cursor-blue mb-3'>
                      {speaker.topic}
                    </h4>
                    <p class='text-gray-600'>{speaker.bio}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </section>
    </div>
  ) : (
    <!-- Regular Event Page -->
    <div class='min-h-screen'>
      <!-- Hero Section -->
      <section class='hero-bg section-padding'>
        <div class='max-w-7xl mx-auto container-padding'>
          <!-- Back Link and Title - Full Width -->
          <div class='mb-12'>
            <a
              href='/events'
              class='inline-flex items-center text-cursor-blue hover:text-blue-700 transition-colors duration-200 mb-6'
            >
              <ArrowLeft className='w-4 h-4 mr-2' />
              Back to Events
            </a>

            <h1 class='text-4xl lg:text-6xl font-bold text-gray-900 leading-tight'>
              {data.title}
            </h1>
          </div>

          <div class='grid grid-cols-1 lg:grid-cols-2 gap-12 items-start'>
            <!-- Event Details -->
            <div class='space-y-8'>
              <p class='text-xl text-gray-600'>{data.description}</p>

              <div class='space-y-4'>
                <div class='flex items-center space-x-3'>
                  <Calendar className='w-5 h-5 text-cursor-blue' />
                  <span class='text-gray-700'>
                    {eventDate.toLocaleDateString('en-US', {
                      weekday: 'long',
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })}
                  </span>
                </div>

                <div class='flex items-center space-x-3'>
                  <Clock className='w-5 h-5 text-cursor-blue' />
                  <span class='text-gray-700'>
                    {data.startTime} - {data.endTime} {data.timezone}
                  </span>
                </div>

                <div class='flex items-center space-x-3'>
                  <MapPin className='w-5 h-5 text-cursor-blue' />
                  <span class='text-gray-700'>{data.location}</span>
                </div>
              </div>

              <!-- Tags -->
              {data.tags && data.tags.length > 0 && (
                <div class='flex flex-wrap gap-2'>
                  {data.tags.map(tag => (
                    <span class='px-3 py-1 bg-cursor-blue/10 text-cursor-blue rounded-full text-sm font-medium'>
                      {tag}
                    </span>
                  ))}
                </div>
              )}

              <!-- Registration Button -->
              {data.registrationUrl && (
                <div class='pt-4'>
                  <a
                    href={data.registrationUrl}
                    target='_blank'
                    rel='noopener noreferrer'
                    class='btn btn-primary btn-lg inline-flex items-center'
                  >
                    {isUpcoming ? 'Register Now' : 'View Event'}
                    <ExternalLink className='w-4 h-4 ml-2' />
                  </a>
                </div>
              )}
            </div>

            <!-- Event Image -->
            <div class='relative'>
              {(data.eventDetailImage || data.image) && (
                <div class='relative aspect-[16/9] rounded-2xl overflow-hidden shadow-2xl'>
                  <img
                    src={data.eventDetailImage || data.image}
                    alt={data.title}
                    class='object-cover w-full h-full'
                  />
                </div>
              )}
            </div>
          </div>
        </div>
      </section>

      <!-- Event Content -->
      <section class='section-padding bg-white'>
        <div class='max-w-4xl mx-auto container-padding'>
          <div class='prose prose-lg max-w-none'>
            <Content />
          </div>
        </div>
      </section>

      <!-- Speakers Section -->
      {data.speakers && data.speakers.length > 0 && (
        <section class='section-padding bg-gray-50'>
          <div class='max-w-7xl mx-auto container-padding'>
            <div class='text-center mb-12'>
              <h2 class='text-3xl lg:text-4xl font-bold gradient-text mb-4'>
                Speakers
              </h2>
              <p class='text-lg text-gray-600'>
                Meet the experts sharing their knowledge
              </p>
            </div>

            <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
              {data.speakers.map((speaker) => (
                <div class='bg-white rounded-2xl p-8 shadow-lg'>
                  <div class='space-y-4'>
                    <h3 class='text-xl font-bold text-gray-900'>
                      {speaker.name}
                    </h3>
                    <h4 class='text-lg font-semibold text-cursor-blue'>
                      {speaker.topic}
                    </h4>
                    <p class='text-gray-600'>{speaker.bio}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- Call to Action -->
      <section class='section-padding bg-white'>
        <div class='max-w-4xl mx-auto container-padding text-center'>
          <div class='space-y-8'>
            <div>
              <h2 class='text-3xl lg:text-4xl font-bold gradient-text mb-4'>
                Join Our Community
              </h2>
              <p class='text-lg text-gray-600'>
                Stay connected with Cursor Italy for more events and updates
              </p>
            </div>

            <div class='flex flex-wrap justify-center gap-4'>
              <a
                href={siteConfig.social.meetup || '#'}
                target='_blank'
                rel='noopener noreferrer'
                class='btn btn-primary'
              >
                Join on Meetup
              </a>
              <a
                href={siteConfig.social.linkedin || '#'}
                target='_blank'
                rel='noopener noreferrer'
                class='btn btn-secondary'
              >
                Follow on LinkedIn
              </a>
            </div>
          </div>
        </div>
      </section>
    </div>
  )}
</BaseLayout>
